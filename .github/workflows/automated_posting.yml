name: ðŸ¤– Automated Blog Posting System

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      research_file:
        description: 'ãƒªã‚µãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«å (optional)'
        required: false
        type: string
      dry_run:
        description: 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå®Ÿéš›ã«ã¯æŠ•ç¨¿ã—ãªã„ï¼‰'
        required: false
        type: boolean
        default: false

  # Pushãƒˆãƒªã‚¬ãƒ¼
  push:
    paths:
      - 'inputs/research_results/pending/*.json'
      - 'inputs/research_results/pending/*.md'
    branches:
      - main
      - master

  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆæ¯Žæ—¥åˆå‰2æ™‚ï¼‰
  schedule:
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  TIMEZONE: 'Asia/Tokyo'

jobs:
  # ç’°å¢ƒãƒã‚§ãƒƒã‚¯
  check-environment:
    name: ðŸ” Environment Check
    runs-on: ubuntu-latest
    outputs:
      has-pending-files: ${{ steps.check-files.outputs.has-files }}
      pending-count: ${{ steps.check-files.outputs.count }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Pending Research Files
        id: check-files
        run: |
          if [ -d "inputs/research_results/pending" ]; then
            file_count=$(find inputs/research_results/pending -name "*.json" -o -name "*.md" | wc -l)
            if [ $file_count -gt 0 ]; then
              echo "has-files=true" >> $GITHUB_OUTPUT
              echo "count=$file_count" >> $GITHUB_OUTPUT
              echo "âœ… å‡¦ç†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: $file_count å€‹"
            else
              echo "has-files=false" >> $GITHUB_OUTPUT
              echo "count=0" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ å‡¦ç†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
            fi
          else
            echo "has-files=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ pending ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi

      - name: Environment Summary
        run: |
          echo "### ðŸŒ Environment Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Pending Files**: ${{ steps.check-files.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Processing Required**: ${{ steps.check-files.outputs.has-files }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  # ãƒ¡ã‚¤ãƒ³å‡¦ç†
  generate-and-publish:
    name: ðŸš€ Generate & Publish Articles
    runs-on: ubuntu-latest
    needs: check-environment
    if: needs.check-environment.outputs.has-pending-files == 'true' || github.event.inputs.research_file != ''
    
    strategy:
      matrix:
        node-version: [18]
      fail-fast: false

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ—ï¸ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: ðŸ”§ Create Required Directories
        run: |
          mkdir -p logs
          mkdir -p outputs/{parsed_research,generated_content,published_posts}
          mkdir -p inputs/research_results/{pending,completed}
          echo "âœ… Directory structure created"

      - name: ðŸ” Parse GPT Research Results
        id: parse-research
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ðŸ” Starting research parsing..."
          if npm run parse-research; then
            echo "parse-success=true" >> $GITHUB_OUTPUT
            echo "âœ… Research parsing completed"
          else
            echo "parse-success=false" >> $GITHUB_OUTPUT
            echo "âŒ Research parsing failed"
            exit 1
          fi

      - name: ðŸ“ Generate Article Content
        id: generate-content
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ðŸ“ Starting content generation..."
          if npm run generate-content; then
            echo "content-success=true" >> $GITHUB_OUTPUT
            echo "âœ… Content generation completed"
          else
            echo "content-success=false" >> $GITHUB_OUTPUT
            echo "âŒ Content generation failed"
            exit 1
          fi

      - name: ðŸ“Š Generate Charts and Visual Elements
        id: generate-charts
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ðŸ“Š Starting chart generation..."
          if npm run generate-charts; then
            echo "charts-success=true" >> $GITHUB_OUTPUT
            echo "âœ… Chart generation completed"
          else
            echo "charts-success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Chart generation failed, continuing without charts"
          fi

      - name: ðŸ” Content Quality Check
        id: quality-check
        run: |
          echo "ðŸ” Running content quality checks..."
          
          # ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç¢ºèª
          content_files=$(find outputs/generated_content -name "*_content.json" | wc -l)
          echo "Generated content files: $content_files"
          
          if [ $content_files -gt 0 ]; then
            echo "âœ… Quality check passed"
            echo "quality-passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No content files generated"
            echo "quality-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ“¤ Publish to WordPress (Production)
        id: publish-wordpress
        if: github.event.inputs.dry_run != 'true'
        env:
          WORDPRESS_API_URL: ${{ secrets.WORDPRESS_API_URL }}
          WORDPRESS_USERNAME: ${{ secrets.WORDPRESS_USERNAME }}
          WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo "ðŸ“¤ Publishing to WordPress..."
          if npm run publish; then
            echo "publish-success=true" >> $GITHUB_OUTPUT
            echo "âœ… WordPress publishing completed"
          else
            echo "publish-success=false" >> $GITHUB_OUTPUT
            echo "âŒ WordPress publishing failed"
            exit 1
          fi

      - name: ðŸ“¤ Dry Run - WordPress Publishing Simulation
        id: dry-run-publish
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸ§ª Dry run mode - WordPress publishing simulation"
          echo "Would publish the following files:"
          find outputs/generated_content -name "*_content.json" -exec basename {} \;
          echo "dry-run-success=true" >> $GITHUB_OUTPUT

      - name: ðŸ“ Move Processed Files
        run: |
          echo "ðŸ“ Moving processed research files..."
          if [ -d "inputs/research_results/pending" ] && [ "$(ls -A inputs/research_results/pending)" ]; then
            mv inputs/research_results/pending/* inputs/research_results/completed/ 2>/dev/null || true
            echo "âœ… Files moved to completed directory"
          else
            echo "â„¹ï¸ No files to move"
          fi

      - name: ðŸ“Š Generate Processing Summary
        id: summary
        run: |
          echo "ðŸ“Š Generating processing summary..."
          
          parsed_files=$(find outputs/parsed_research -name "*_structured.json" 2>/dev/null | wc -l)
          content_files=$(find outputs/generated_content -name "*_content.json" 2>/dev/null | wc -l)
          published_files=$(find outputs/published_posts -name "*_published.json" 2>/dev/null | wc -l)
          
          echo "### ðŸš€ Automation Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Count | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ Research Parsed | $parsed_files | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Content Generated | $content_files | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¤ Articles Published | $published_files | $( [ '${{ steps.publish-wordpress.outputs.publish-success }}' = 'true' ] && echo 'âœ…' || echo 'âš ï¸' ) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Processing Time**: $(date -u -d @$SECONDS +%T)" >> $GITHUB_STEP_SUMMARY
          
          echo "summary-generated=true" >> $GITHUB_OUTPUT

      - name: ðŸ”„ Commit Results
        if: steps.summary.outputs.summary-generated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add outputs/ inputs/research_results/completed/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "ðŸ¤– Automated blog processing results

          - Parsed research files: $(find outputs/parsed_research -name "*_structured.json" 2>/dev/null | wc -l)
          - Generated content files: $(find outputs/generated_content -name "*_content.json" 2>/dev/null | wc -l)  
          - Published articles: $(find outputs/published_posts -name "*_published.json" 2>/dev/null | wc -l)
          
          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: GitHub Actions <action@github.com>"
            
            git push
            echo "âœ… Results committed and pushed"
          fi

      - name: ðŸ“‹ Upload Processing Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processing-logs-${{ github.run_number }}
          path: |
            logs/
            outputs/
          retention-days: 30

  # é€šçŸ¥å‡¦ç†
  notify-completion:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [check-environment, generate-and-publish]
    if: always()
    
    steps:
      - name: ðŸ“Š Calculate Results
        id: results
        run: |
          if [ "${{ needs.generate-and-publish.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… ãƒ–ãƒ­ã‚°è‡ªå‹•åŒ–å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ" >> $GITHUB_OUTPUT
          elif [ "${{ needs.generate-and-publish.result }}" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ ãƒ–ãƒ­ã‚°è‡ªå‹•åŒ–å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> $GITHUB_OUTPUT
          elif [ "${{ needs.check-environment.outputs.has-pending-files }}" = "false" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT  
            echo "message=â„¹ï¸ å‡¦ç†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ãŸã‚ã€å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ" >> $GITHUB_OUTPUT
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "message=âš ï¸ ä¸æ˜ŽãªçŠ¶æ…‹ã§ã™" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¢ Create Summary
        run: |
          echo "### ðŸš€ Automated Blog Processing Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.results.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY