name: Complete Article Workflow

on:
  workflow_dispatch:
    inputs:
      workflow_type:
        description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—'
        required: true
        type: choice
        options:
          - 'keyword-analysis-to-wordpress'
          - 'markdown-to-wordpress-only'
      keyword_analysis_file:
        description: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æãƒ•ã‚¡ã‚¤ãƒ«å (ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æçµæœã€‘.txt ãªã©)'
        required: false
        type: string
      auto_upload:
        description: 'è¨˜äº‹ä½œæˆå¾Œã€è‡ªå‹•çš„ã«WordPressã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹'
        required: false
        default: true
        type: boolean

jobs:
  process-articles:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install

    - name: Generate articles from keyword analysis
      if: github.event.inputs.workflow_type == 'keyword-analysis-to-wordpress'
      run: |
        echo "ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æã‹ã‚‰è¨˜äº‹ç”Ÿæˆã‚’é–‹å§‹..."
        echo "ã“ã®æ®µéšã§ã¯æ‰‹å‹•ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æçµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€Claude Codeã§è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„"
        echo "ç”Ÿæˆã•ã‚ŒãŸ.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’outputsãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã¦ãã ã•ã„"

    - name: List generated markdown files
      run: |
        echo "ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«:"
        ls -la outputs/*.md || echo "Markdownãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

    - name: Upload Markdown articles to WordPress
      if: github.event.inputs.auto_upload == 'true'
      env:
        WORDPRESS_API_URL: ${{ secrets.WORDPRESS_API_URL }}
        WORDPRESS_USERNAME: ${{ secrets.WORDPRESS_USERNAME }}
        WORDPRESS_APP_PASSWORD: ${{ secrets.WORDPRESS_APP_PASSWORD }}
      run: |
        echo "ğŸ“¤ Markdownè¨˜äº‹ã‚’WordPressã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰..."
        node src/upload_md_articles.js

    - name: Generate summary report
      run: |
        echo "ğŸ“Š ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ã‚µãƒãƒªãƒ¼"
        echo "========================"
        echo "å‡¦ç†ã‚¿ã‚¤ãƒ—: ${{ github.event.inputs.workflow_type }}"
        echo "è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: ${{ github.event.inputs.auto_upload }}"
        echo "å‡¦ç†æ—¥æ™‚: $(date)"
        echo "========================"

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --staged --quiet || git commit -m "Auto: Complete article workflow completed ğŸ¤–"
        git push

  notify-completion:
    needs: process-articles
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Workflow completion notification
      run: |
        echo "ğŸ‰ Complete Article Workflow ãŒå®Œäº†ã—ã¾ã—ãŸ"
        echo "çµæœ: ${{ needs.process-articles.result }}"